<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Roue Ap√©ro de Nuit 66</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- META pour l‚Äôaper√ßu quand tu partages le lien (Messenger, etc.) -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Roue Ap√©ro de Nuit 66 - Gagne ton cadeau">
  <meta property="og:description" content="Laisse ton avis et tente de gagner livraison offerte, r√©ductions ou bouteilles avec Ap√©ro de Nuit 66.">
  <meta property="og:image" content="https://image.noelshack.com/fichiers/2025/50/4/1765467448-image-frigo-2.jpeg">
  <!-- ‚ö†Ô∏è √Ä MODIFIER : mets ici l‚ÄôURL exacte de la page GitHub Pages -->
  <meta property="og:url" content="https://TON-USER.github.io/TON-REPO/">

  <!-- Optionnel mais utile pour Twitter / certains clients -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Roue Ap√©ro de Nuit 66 - Gagne ton cadeau">
  <meta name="twitter:description" content="Laisse ton avis et tente de gagner livraison offerte, r√©ductions ou bouteilles avec Ap√©ro de Nuit 66.">
  <meta name="twitter:image" content="https://image.noelshack.com/fichiers/2025/50/4/1765467448-image-frigo-2.jpeg">

  <!-- Ancienne balise utilis√©e par certains services -->
  <link rel="image_src" href="https://image.noelshack.com/fichiers/2025/50/4/1765467448-image-frigo-2.jpeg" />

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: radial-gradient(circle at top, #1c2740 0%, #02030a 60%, #000 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #fff;
      overflow-x: hidden;
    }
    .lang-flag {
      position: fixed;
      top: 8px;
      right: 10px;
      font-size: 22px;
      z-index: 1000;
    }
    /* FL√àCHE ROUGE */
    .pointer {
      width: 0;
      height: 0;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-top: 34px solid #ff3b2f;
      margin-top: 50px;
    }
    .wheel-container {
      display: flex;
      justify-content: center;
      margin-top: 5px;
    }
    #wheel {
      width: 330px;
      height: 330px;
      border-radius: 50%;
      background-image: url("https://image.noelshack.com/fichiers/2025/50/3/1765329444-file-00000000486c71f49c21aafc0dae1d69-2.jpg");
      background-size: cover;
      background-position: center;
      transition: transform 6s cubic-bezier(0.15, 0.85, 0.15, 1); /* 6 s */
      filter: drop-shadow(0 0 22px rgba(255,215,0,0.8));
      cursor: pointer;
    }
    #spinButton {
      margin-top: 25px;
      padding: 16px 32px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #00c6ff, #0072ff);
      color: #fff;
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
      width: 80%;
      max-width: 320px;
    }
    #spinButton:disabled { opacity: 0.5; cursor: default; }
    #result {
      margin-top: 16px;
      font-size: 18px;
      min-height: 1.6em;
      text-align: center;
    }
    .overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(6px);
    }
    /* POPUP JOUER */
    .play-overlay {
      background: rgba(5, 10, 25, 0.80) !important;
    }
    .card {
      background: #ffffffee;
      color: #111;
      width: 86vw;
      max-width: 360px;
      border-radius: 22px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
    }
    .play-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .play-header h2 {
      margin: 0;
      font-size: 24px;
    }
    .play-steps {
      margin: 8px 0 0 0;
      padding-left: 22px;
      color: #555;
      font-size: 16px;
    }
    .primary-btn {
      margin-top: 22px;
      width: 100%;
      padding: 13px;
      border-radius: 999px;
      border: none;
      background: #1a73e8;
      color: #fff;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
    }
    /* EMOJIS */
    .emoji-row {
      display: flex;
      justify-content: center;
      gap: 18px;
      margin-top: 12px;
    }
    .emoji-btn {
      border: none;
      background: none;
      cursor: pointer;
      text-align: center;
    }
    .emoji-icon { font-size: 36px; margin-bottom: 4px; }
    .emoji-label { font-size: 13px; font-weight: 600; }
    /* POPUP NOTE GOOGLE */
    .star-container {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin: 10px 0;
    }
    .star {
      font-size: 32px;
      cursor: pointer;
      color: #dadce0;
      transition: 0.15s;
    }
    .star.active {
      color: #fbbc05;
      transform: scale(1.15);
    }
    #badComment {
      width: 100%;
      min-height: 90px;
      margin-top: 6px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #ccc;
      resize: vertical;
    }
    /* BARRE DE CHARGEMENT */
    .loading-bar {
      width: 100%;
      height: 4px;
      border-radius: 999px;
      background: rgba(26,115,232,0.18);
      overflow: hidden;
      margin-top: 10px;
      display: none;
    }
    .loading-bar-inner {
      width: 40%;
      height: 100%;
      background: #1a73e8;
      border-radius: inherit;
      transform: translateX(-100%);
      animation: loadingSlide 1s linear infinite;
    }
    @keyframes loadingSlide {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(260%); }
    }
    /* POPUP GAIN */
    .prize-card { text-align: left; }
    .prize-title {
      margin: 0 0 8px;
      font-size: 22px;
    }
    .prize-text {
      margin: 0 0 12px;
      font-size: 15px;
      color: #444;
    }
    /* zone du CODE plus GRIS */
    .prize-code {
      margin: 14px 0 8px;
      padding: 10px 14px;
      border-radius: 14px;
      background: #d4d4d4;
      color: #111;
      text-align: center;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.06em;
    }
    .prize-site {
      margin: 4px 0 4px;
      font-size: 14px;
      color: #5f6368;
      text-align: center;
    }
    .prize-dates {
      margin: 4px 0 0;
      font-size: 12px;
      color: #9aa0a6;
      text-align: center;
    }
    .prize-btn-site {
      margin-top: 18px;
      width: 100%;
      padding: 12px;
      border-radius: 999px;
      border: none;
      background: #00a86b;
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
  
/* =====================================================
   IMMERSIVE FX (win popup): glow + light sweep + confetti
   Added without removing any existing logic.
   ===================================================== */
@keyframes fxGlowPulse {
  0%   { box-shadow: 0 0 10px rgba(0,255,204,.35), 0 0 0 rgba(0,0,0,0); transform: translateZ(0) scale(1); }
  50%  { box-shadow: 0 0 24px rgba(0,255,204,.55), 0 0 60px rgba(0,255,204,.25); transform: translateZ(0) scale(1.01); }
  100% { box-shadow: 0 0 10px rgba(0,255,204,.35), 0 0 0 rgba(0,0,0,0); transform: translateZ(0) scale(1); }
}
@keyframes fxLightSweep {
  0%   { transform: translateX(-140%) rotate(14deg); opacity: 0; }
  15%  { opacity: .55; }
  100% { transform: translateX(140%) rotate(14deg); opacity: 0; }
}
.fx-win-glow {
  animation: fxGlowPulse 1.35s ease-in-out infinite;
}
/* light sweep overlay */
.prize-card { position: relative; overflow: hidden; }
.prize-card.fx-win-sweep::after{
  content:"";
  position:absolute;
  top:-30%;
  left:-60%;
  width: 55%;
  height: 160%;
  background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,.55) 50%, transparent 100%);
  filter: blur(1px);
  animation: fxLightSweep 1.15s ease-out 1;
  pointer-events:none;
}
#fxConfettiCanvas{
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none;
  z-index: 999999; /* above overlays */
}

</style>
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "38b45559-ffdb-43f1-a533-18aa30b3cfac",
    });
  });
</script>

</head>
<body>
  <div class="lang-flag">üá´üá∑</div>
  <div class="pointer"></div>
  <div class="wheel-container">
    <div id="wheel"></div>
  </div>
  <button id="spinButton">TOURNER LA ROUE</button>
  <div id="result"></div>

  <!-- POPUP JOUER -->
  <div id="playOverlay" class="overlay play-overlay">
    <div class="card">
      <div class="play-header">
        <h2>Jouer</h2>
        <span>üá´üá∑</span>
      </div>
      <ol class="play-steps">
        <li>Laissez-nous votre avis</li>
        <li>Retournez √† la page du jeu ‚Ü©</li>
        <li>Jouez pour gagner un cadeau</li>
      </ol>
      <button id="btnGoToReview" class="primary-btn">‚≠ê Avis</button>
    </div>
  </div>

  <!-- POPUP EMOJIS -->
  <div id="reviewOverlay" class="overlay" style="background:rgba(0,0,0,0.55);">
    <div class="card">
      <h2>Laissez votre avis</h2>
      <p>Partagez votre exp√©rience :</p>
      <div class="emoji-row">
        <button id="btnBad" class="emoji-btn">
          <span class="emoji-icon">üò°</span>
          <div class="emoji-label" style="color:#e53935">Horrible</div>
        </button>
        <button id="btnMedium" class="emoji-btn">
          <span class="emoji-icon">üòê</span>
          <div class="emoji-label" style="color:#fbc02d">Moyen</div>
        </button>
        <button id="btnGood" class="emoji-btn">
          <span class="emoji-icon">üòÅ</span>
          <div class="emoji-label" style="color:#43a047">Excellent</div>
        </button>
      </div>
    </div>
  </div>

  <!-- POPUP NOTE INTERNE -->
  <div id="starOverlay" class="overlay" style="background:rgba(0,0,0,0.55);">
    <div class="card">
      <h2>Votre avis</h2>
      <p>Notez votre exp√©rience :</p>
      <div class="star-container">
        <span class="star" data-value="1">‚òÖ</span>
        <span class="star" data-value="2">‚òÖ</span>
        <span class="star" data-value="3">‚òÖ</span>
        <span class="star" data-value="4">‚òÖ</span>
        <span class="star" data-value="5">‚òÖ</span>
      </div>
      <textarea id="badComment" placeholder="Partagez votre exp√©rience ici‚Ä¶"></textarea>
      <div id="loadingBar" class="loading-bar">
        <div class="loading-bar-inner"></div>
      </div>
      <button id="btnPublishInternal" class="primary-btn">Publier</button>
    </div>
  </div>

  <!-- POPUP GAIN -->
  <div id="prizeOverlay" class="overlay" style="background:rgba(0,0,0,0.65);">
    <div class="card prize-card">
      <h2 id="prizeTitle" class="prize-title"></h2>
      <p id="prizeText" class="prize-text"></p>
      <div id="prizeCode" class="prize-code"></div>
      <p id="prizeSite" class="prize-site"></p>
      <p id="prizeDates" class="prize-dates"></p>
      <button id="btnSeeSite" class="prize-btn-site">Voir le site</button>
    </div>
  </div>

<script>
const wheel = document.getElementById("wheel");
const spinButton = document.getElementById("spinButton");
const result = document.getElementById("result");

const segments = [
  "iPhone 16",
  "Livraison offerte",
  "-10%",
  "Une bouteille de Poliakov",
  "-10%",
  "-50%"
];

const prizeWeights = {
  "iPhone 16": 0,
  "-10%": 40,
  "Livraison offerte": 40,
  "-50%": 15,
  "Une bouteille de Poliakov": 2
};

const prizePopupContent = {
  "iPhone 16": {
    title: "üéâ iPhone 16",
    text: "Jackpot th√©orique iPhone 16 (probabilit√© 0 % dans ce jeu).",
    code: "IPH16"
  },
  "Livraison offerte": {
    title: "üöö Livraison offerte",
    text: "Tu as gagn√© la livraison offerte sur ta prochaine commande.",
    code: "L1V0F"
  },
  "-10%": {
    title: "üéÅ R√©duction -10%",
    text: "Tu as gagn√© -10% sur ta prochaine commande.",
    code: "T9H3A"
  },
  "-50%": {
    title: "üî• R√©duction -50%",
    text: "Tu as gagn√© -50% sur ta prochaine commande.",
    code: "Q5L8Z"
  },
  "Une bouteille de Poliakov": {
    title: "üçæ Bouteille de Poliakov",
    text: "Tu as gagn√© une bouteille de Poliakov.",
    code: "P0LK4"
  }
};

let currentRotation = 0;
let canSpin = false;
let isSpinning = false;
const sectorCount = segments.length;
const sectorSize = 360 / sectorCount;

/* Gestion du verrou 3 mois */
let isLockedFromPrize = false;
let savedPrizeData = null;

function randomWeighted() {
  const weights = segments.map(s => prizeWeights[s] || 0);
  let total = weights.reduce((a,b)=>a+b,0);
  if (total <= 0) return Math.floor(Math.random() * segments.length);
  let r = Math.random() * total;
  for (let i=0;i<weights.length;i++){
    r -= weights[i];
    if (r <= 0) return i;
  }
  return 0;
}

function formatDateFr(d) {
  return d.toLocaleDateString("fr-FR");
}

/* Pop-up gain */
const prizeOverlay = document.getElementById("prizeOverlay");
const prizeTitle = document.getElementById("prizeTitle");
const prizeText = document.getElementById("prizeText");
const prizeCode = document.getElementById("prizeCode");
const prizeSite = document.getElementById("prizeSite");
const prizeDates = document.getElementById("prizeDates");
const btnSeeSite = document.getElementById("btnSeeSite");

/* URL vers ton site */
const SITE_URL = "https://www.aperodenuit.com/";

/**
 * Affiche le popup de gain.
 * Si storedData est fourni, on r√©utilise les dates & infos d√©j√† enregistr√©es.
 */
function showPrizePopup(prizeName, storedData) {
  const data = prizePopupContent[prizeName] || {
    title: "Lot gagn√©",
    text: "Contenu √† d√©finir.",
    code: "XXXXX"
  };

  prizeTitle.textContent = data.title;
  prizeText.textContent = data.text;
  prizeCode.textContent = "CODE : " + data.code;
  prizeSite.textContent = "Valable sur aperodenuit.com";

  let start, end, lockUntil;

  if (storedData && storedData.start && storedData.end && storedData.lockUntil) {
    start = new Date(storedData.start);
    end = new Date(storedData.end);
    lockUntil = new Date(storedData.lockUntil);
  } else {
    const today = new Date();
    start = new Date(today);
    start.setDate(start.getDate() - 1);
    end = new Date(today);
    end.setDate(end.getDate() + 67);

    // Verrouillage pendant 3 mois
    lockUntil = new Date(today);
    lockUntil.setMonth(lockUntil.getMonth() + 3);

    // Sauvegarde dans localStorage
    const toSave = {
      prizeName,
      code: data.code,
      start: start.toISOString(),
      end: end.toISOString(),
      lockUntil: lockUntil.toISOString()
    };
    savedPrizeData = toSave;
    isLockedFromPrize = true;
    try {
      localStorage.setItem("aperoRouePrize", JSON.stringify(toSave));
    } catch (e) {
      console.error("Impossible de sauvegarder le gain :", e);
    }
  }

  prizeDates.textContent = "Du " + formatDateFr(start) + " au " + formatDateFr(end);
  prizeOverlay.style.display = "flex";

  // FX immersifs: plein effet pour un gain nouveau, soft si gain d√©j√† enregistr√©
  try { window.triggerWinFX({ mode: storedData ? "soft" : "full" }); } catch(e) {}


  if (lockUntil) {
    result.textContent = "üéÅ Tu as d√©j√† jou√©. Tu pourras rejouer apr√®s le " + formatDateFr(lockUntil) + ".";
  }
}

btnSeeSite.addEventListener("click", () => {
  window.open(SITE_URL, "_blank");
});

/* Popups avis */
const playOverlay = document.getElementById("playOverlay");
const reviewOverlay = document.getElementById("reviewOverlay");
const starOverlay = document.getElementById("starOverlay");

document.getElementById("btnGoToReview").onclick = () => {
  // Si d√©j√† verrouill√© par un gain, on affiche juste le gain
  if (isLockedFromPrize && savedPrizeData) {
    showPrizePopup(savedPrizeData.prizeName, savedPrizeData);
    return;
  }
  playOverlay.style.display = "none";
  reviewOverlay.style.display = "flex";
};

/* Emojis */
document.getElementById("btnBad").onclick = () => {
  reviewOverlay.style.display = "none";
  starOverlay.style.display = "flex";
};

document.getElementById("btnMedium").onclick = () => {
  reviewOverlay.style.display = "none";
  starOverlay.style.display = "flex";
};

document.getElementById("btnGood").onclick = () => {
  // Lien Google Avis mis √† jour
  window.open("https://g.page/r/CeR1XkHseNX9EBM/review", "_blank");
  reviewOverlay.style.display = "none";
  // On ne redonne le droit de jouer que si pas d√©j√† verrouill√© par un gain
  spinButton.disabled = true;
  result.textContent = "";
  setTimeout(() => {
    if (!isLockedFromPrize) {
      canSpin = true;
      spinButton.disabled = false;
      result.textContent = "‚úÖ Tu peux maintenant tourner la roue.";
    }
  }, 10000);
};

/* √âtoiles */
let internalRating = 0;
document.querySelectorAll(".star").forEach(star => {
  star.onclick = () => {
    internalRating = Number(star.dataset.value);
    document.querySelectorAll(".star").forEach(s => {
      s.classList.toggle("active", Number(s.dataset.value) <= internalRating);
    });
  };
});

/* Publier avis interne + barre chargement */
document.getElementById("btnPublishInternal").onclick = () => {
  if (internalRating === 0) {
    alert("Merci de choisir une note.");
    return;
  }
  const loadingBar = document.getElementById("loadingBar");
  loadingBar.style.display = "block";
  setTimeout(() => {
    loadingBar.style.display = "none";
    starOverlay.style.display = "none";
    spinButton.disabled = true;
    result.textContent = "";
    setTimeout(() => {
      if (!isLockedFromPrize) {
        canSpin = true;
        spinButton.disabled = false;
        result.textContent = "‚úÖ Tu peux maintenant tourner la roue.";
      }
    }, 1000);
  }, 1000);
};

/* Spin de la roue (6 secondes) */
function spin() {
  if (!canSpin || isSpinning || isLockedFromPrize) {
    // Si verrouill√© par un gain, on r√©affiche le popup du gain
    if (isLockedFromPrize && savedPrizeData) {
      showPrizePopup(savedPrizeData.prizeName, savedPrizeData);
    }
    return;
  }
  isSpinning = true;
  spinButton.disabled = true;

  const targetIndex = randomWeighted();
  const prizeName = segments[targetIndex];

  const targetDeg = (360 - targetIndex * sectorSize) % 360;
  const currentDeg = ((currentRotation % 360) + 360) % 360;
  const delta = (targetDeg - currentDeg + 360) % 360;

  currentRotation += 360 * 6 + delta;
  wheel.style.transform = `rotate(${currentRotation}deg)`;

  result.textContent = "La roue tourne...";

  setTimeout(() => {
    result.textContent = "üéÅ Tu as gagn√© : " + prizeName + " !";
    setTimeout(() => {
      showPrizePopup(prizeName);
      isSpinning = false;
      // M√™me si showPrizePopup verrouille, on ne r√©active pas vraiment le bouton
      spinButton.disabled = false;
    }, 2000);
  }, 6000);
}

/* Clicks */
spinButton.onclick = () => {
  if (isLockedFromPrize && savedPrizeData) {
    // D√©j√† un gain : on montre le popup de ce gain
    showPrizePopup(savedPrizeData.prizeName, savedPrizeData);
    return;
  }
  if (!canSpin) {
    playOverlay.style.display = "flex";
  } else {
    spin();
  }
};

wheel.onclick = spinButton.onclick;

/* Initialisation : on regarde s'il y a d√©j√† un gain sauvegard√© */
(function initPrizeLock() {
  try {
    const raw = localStorage.getItem("aperoRouePrize");
    if (!raw) return;
    const data = JSON.parse(raw);
    if (!data.lockUntil || !data.prizeName) return;

    const now = new Date();
    const lockUntil = new Date(data.lockUntil);

    if (now < lockUntil) {
      // Toujours verrouill√© : on r√©affiche le gain
      savedPrizeData = data;
      isLockedFromPrize = true;
      canSpin = false;
      showPrizePopup(data.prizeName, data);
    } else {
      // Verrou expir√© : on efface les donn√©es
      localStorage.removeItem("aperoRouePrize");
    }
  } catch (e) {
    console.error("Erreur lors de l'initialisation du gain :", e);
  }
})();
</script>

<script>
  // Demande la permission uniquement au clic sur le bouton
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("spinButton");
    if (!btn) return;

    btn.addEventListener("click", () => {
      try {
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
          try {
            // Chrome n'affiche pas de prompt si d√©j√† "granted" ou "denied"
            if (typeof Notification !== "undefined" && Notification.permission !== "default") return;
            await OneSignal.Notifications.requestPermission();
          } catch (e) {}
        });
      } catch (e) {}
    }, true);
  });
</script>


<script>
/* =====================================================
   IMMERSIVE FX (win popup)
   - Confetti burst (canvas)
   - Premium "win" sound (WebAudio, no external file)
   - Optional haptics on mobile
   Triggered by calling: window.triggerWinFX({mode:"full"|"soft"})
   ===================================================== */
(function(){
  const FX = {
    canvas: null,
    ctx: null,
    particles: [],
    raf: null,
    lastT: 0,
    running: false
  };

  function ensureCanvas(){
    if (FX.canvas) return;
    const c = document.createElement("canvas");
    c.id = "fxConfettiCanvas";
    document.body.appendChild(c);
    FX.canvas = c;
    FX.ctx = c.getContext("2d", { alpha: true });
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);
  }
  function resizeCanvas(){
    if (!FX.canvas) return;
    FX.canvas.width = Math.floor(window.innerWidth * (window.devicePixelRatio || 1));
    FX.canvas.height = Math.floor(window.innerHeight * (window.devicePixelRatio || 1));
    FX.canvas.style.width = "100%";
    FX.canvas.style.height = "100%";
    FX.ctx.setTransform((window.devicePixelRatio||1),0,0,(window.devicePixelRatio||1),0,0);
  }

  function rand(min,max){ return Math.random()*(max-min)+min; }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function burstConfetti(opts){
    ensureCanvas();
    const mode = (opts && opts.mode) || "full";
    const count = mode === "soft" ? 70 : 160;
    const gravity = mode === "soft" ? 700 : 980; // px/s^2
    const drag = 0.12;
    const spread = mode === "soft" ? 0.85 : 1.0;

    const w = window.innerWidth;
    const h = window.innerHeight;

    // Spawn from near center-top of the prize popup area (approx)
    const originX = w * 0.5;
    const originY = h * 0.25;

    const colors = [
      [0,255,204], [255,220,0], [255,80,140], [120,200,255], [255,140,40], [180,255,120]
    ];

    for(let i=0;i<count;i++){
      const rgb = pick(colors);
      FX.particles.push({
        x: originX + rand(-40,40),
        y: originY + rand(-10,10),
        vx: rand(-340,340) * spread,
        vy: rand(-520,-160) * spread,
        r: rand(2.2, 4.8),
        w: rand(6, 14),
        h: rand(3, 8),
        rot: rand(0, Math.PI*2),
        vr: rand(-8, 8),
        life: rand(0.85, 1.35),
        age: 0,
        g: gravity,
        c: `rgba(${rgb[0]},${rgb[1]},${rgb[2]},`,
      });
    }
    startLoop();
  }

  function startLoop(){
    if (FX.running) return;
    FX.running = true;
    FX.lastT = performance.now();
    FX.raf = requestAnimationFrame(tick);
  }

  function tick(t){
    const dt = Math.min(0.033, (t - FX.lastT) / 1000);
    FX.lastT = t;

    const ctx = FX.ctx;
    if (!ctx || !FX.canvas) return stopLoop();

    ctx.clearRect(0,0,window.innerWidth,window.innerHeight);

    // update & draw
    for(let i=FX.particles.length-1;i>=0;i--){
      const p = FX.particles[i];
      p.age += dt;
      p.vx *= (1 - 0.12*dt);
      p.vy += p.g * dt;
      p.x += p.vx * dt;
      p.y += p.vy * dt;
      p.rot += p.vr * dt;

      const alpha = Math.max(0, 1 - (p.age / p.life));
      if (alpha <= 0 || p.y > window.innerHeight + 80) {
        FX.particles.splice(i,1);
        continue;
      }

      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = p.c + (0.85*alpha).toFixed(3) + ")";
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();
    }

    if (FX.particles.length === 0){
      stopLoop();
      return;
    }
    FX.raf = requestAnimationFrame(tick);
  }

  function stopLoop(){
    FX.running = false;
    if (FX.raf) cancelAnimationFrame(FX.raf);
    FX.raf = null;
    if (FX.ctx) FX.ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
  }

  function playWinSound(opts){
    // WebAudio needs user gesture; here we're called from a click-driven flow (spin).
    const mode = (opts && opts.mode) || "full";
    const A = window.AudioContext || window.webkitAudioContext;
    if (!A) return;

    const ac = new A();

    const now = ac.currentTime;
    const master = ac.createGain();
    master.gain.setValueAtTime(mode==="soft" ? 0.18 : 0.26, now);
    master.connect(ac.destination);

    // A short "sparkle" chord (pleasant, not too loud)
    const freqs = mode==="soft" ? [660, 990] : [660, 880, 1320];
    freqs.forEach((f, idx)=>{
      const o = ac.createOscillator();
      const g = ac.createGain();
      o.type = "triangle";
      o.frequency.setValueAtTime(f, now);
      // tiny pitch slide up
      o.frequency.exponentialRampToValueAtTime(f*1.06, now + 0.12);

      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.22/(idx+1), now + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, now + (mode==="soft" ? 0.42 : 0.55));

      o.connect(g);
      g.connect(master);
      o.start(now);
      o.stop(now + (mode==="soft" ? 0.45 : 0.6));
    });

    // tiny noise "tss" (very subtle)
    try{
      const bufferSize = ac.sampleRate * 0.08;
      const buffer = ac.createBuffer(1, bufferSize, ac.sampleRate);
      const out = buffer.getChannelData(0);
      for (let i=0;i<bufferSize;i++) out[i] = (Math.random()*2-1) * 0.18;
      const noise = ac.createBufferSource();
      noise.buffer = buffer;

      const nf = ac.createBiquadFilter();
      nf.type = "highpass";
      nf.frequency.value = 2000;

      const ng = ac.createGain();
      ng.gain.setValueAtTime(0.0001, now);
      ng.gain.exponentialRampToValueAtTime(mode==="soft" ? 0.03 : 0.05, now + 0.01);
      ng.gain.exponentialRampToValueAtTime(0.0001, now + 0.12);

      noise.connect(nf); nf.connect(ng); ng.connect(master);
      noise.start(now);
      noise.stop(now + 0.13);
    }catch(e){}
  }

  function haptic(opts){
    const mode = (opts && opts.mode) || "full";
    if (!("vibrate" in navigator)) return;
    // short & classy
    navigator.vibrate(mode==="soft" ? [18, 18, 18] : [22, 30, 22, 40, 28]);
  }

  function decoratePrizeCard(){
    const card = document.querySelector("#prizeOverlay .prize-card");
    if (!card) return;
    card.classList.remove("fx-win-glow","fx-win-sweep");
    // reflow to replay sweep animation
    void card.offsetWidth;
    card.classList.add("fx-win-glow","fx-win-sweep");
    // stop glow after a bit (keep classy)
    setTimeout(()=>{
      card.classList.remove("fx-win-glow");
    }, 5200);
  }

  window.triggerWinFX = function(opts){
    decoratePrizeCard();
    burstConfetti(opts);
    playWinSound(opts);
    haptic(opts);
  };
})();
</script>

</body>
</html>
