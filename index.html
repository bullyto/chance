<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Roue Ap√©ro de Nuit 66</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- META pour l‚Äôaper√ßu quand tu partages le lien (Messenger, etc.) -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Roue Ap√©ro de Nuit 66 - Gagne ton cadeau">
  <meta property="og:description" content="Laisse ton avis et tente de gagner livraison offerte, r√©ductions ou bouteilles avec Ap√©ro de Nuit 66.">
  <meta property="og:image" content="https://image.noelshack.com/fichiers/2025/50/4/1765467448-image-frigo-2.jpeg">
  <!-- ‚ö†Ô∏è √Ä MODIFIER : mets ici l‚ÄôURL exacte de la page GitHub Pages -->
  <meta property="og:url" content="https://TON-USER.github.io/TON-REPO/">

  <!-- Optionnel mais utile pour Twitter / certains clients -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Roue Ap√©ro de Nuit 66 - Gagne ton cadeau">
  <meta name="twitter:description" content="Laisse ton avis et tente de gagner livraison offerte, r√©ductions ou bouteilles avec Ap√©ro de Nuit 66.">
  <meta name="twitter:image" content="https://image.noelshack.com/fichiers/2025/50/4/1765467448-image-frigo-2.jpeg">

  <!-- Ancienne balise utilis√©e par certains services -->
  <link rel="image_src" href="https://image.noelshack.com/fichiers/2025/50/4/1765467448-image-frigo-2.jpeg" />

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: radial-gradient(circle at top, #1c2740 0%, #02030a 60%, #000 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #fff;
      overflow-x: hidden;
    }
    .lang-flag {
      position: fixed;
      top: 8px;
      right: 10px;
      font-size: 22px;
      z-index: 1000;
    }
    /* FL√àCHE ROUGE */
    .pointer {
      width: 0;
      height: 0;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-top: 34px solid #ff3b2f;
      margin-top: 50px;
    }
    .wheel-container {
      display: flex;
      justify-content: center;
      margin-top: 5px;
    }
    #wheel {
      width: 330px;
      height: 330px;
      border-radius: 50%;
      background-image: url("https://image.noelshack.com/fichiers/2025/50/3/1765329444-file-00000000486c71f49c21aafc0dae1d69-2.jpg");
      background-size: cover;
      background-position: center;
      transition: transform 6s cubic-bezier(0.15, 0.85, 0.15, 1); /* 6 s */
      filter: drop-shadow(0 0 22px rgba(255,215,0,0.8));
      cursor: pointer;
    }
    #spinButton {
      margin-top: 25px;
      padding: 16px 32px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #00c6ff, #0072ff);
      color: #fff;
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
      width: 80%;
      max-width: 320px;
    }
    #spinButton:disabled { opacity: 0.5; cursor: default; }
    #result {
      margin-top: 16px;
      font-size: 18px;
      min-height: 1.6em;
      text-align: center;
    }
    .overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(6px);
    }
    /* POPUP JOUER */
    .play-overlay {
      background: rgba(5, 10, 25, 0.80) !important;
    }
    .card {
      background: #ffffffee;
      color: #111;
      width: 86vw;
      max-width: 360px;
      border-radius: 22px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
    }
    .play-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .play-header h2 {
      margin: 0;
      font-size: 24px;
    }
    .play-steps {
      margin: 8px 0 0 0;
      padding-left: 22px;
      color: #555;
      font-size: 16px;
    }
    .primary-btn {
      margin-top: 22px;
      width: 100%;
      padding: 13px;
      border-radius: 999px;
      border: none;
      background: #1a73e8;
      color: #fff;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
    }
    /* EMOJIS */
    .emoji-row {
      display: flex;
      justify-content: center;
      gap: 18px;
      margin-top: 12px;
    }
    .emoji-btn {
      border: none;
      background: none;
      cursor: pointer;
      text-align: center;
    }
    .emoji-icon { font-size: 36px; margin-bottom: 4px; }
    .emoji-label { font-size: 13px; font-weight: 600; }
    /* POPUP NOTE GOOGLE */
    .star-container {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin: 10px 0;
    }
    .star {
      font-size: 32px;
      cursor: pointer;
      color: #dadce0;
      transition: 0.15s;
    }
    .star.active {
      color: #fbbc05;
      transform: scale(1.15);
    }
    #badComment {
      width: 100%;
      min-height: 90px;
      margin-top: 6px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #ccc;
      resize: vertical;
    }
    /* BARRE DE CHARGEMENT */
    .loading-bar {
      width: 100%;
      height: 4px;
      border-radius: 999px;
      background: rgba(26,115,232,0.18);
      overflow: hidden;
      margin-top: 10px;
      display: none;
    }
    .loading-bar-inner {
      width: 40%;
      height: 100%;
      background: #1a73e8;
      border-radius: inherit;
      transform: translateX(-100%);
      animation: loadingSlide 1s linear infinite;
    }
    @keyframes loadingSlide {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(260%); }
    }
    /* POPUP GAIN */
    .prize-card { text-align: left; }
    .prize-title {
      margin: 0 0 8px;
      font-size: 22px;
    }
    .prize-text {
      margin: 0 0 12px;
      font-size: 15px;
      color: #444;
    }
    /* zone du CODE plus GRIS */
    .prize-code {
      margin: 14px 0 8px;
      padding: 10px 14px;
      border-radius: 14px;
      background: #d4d4d4;
      color: #111;
      text-align: center;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.06em;
    }
    .prize-site {
      margin: 4px 0 4px;
      font-size: 14px;
      color: #5f6368;
      text-align: center;
    }
    .prize-dates {
      margin: 4px 0 0;
      font-size: 12px;
      color: #9aa0a6;
      text-align: center;
    }
    .prize-btn-site {
      margin-top: 18px;
      width: 100%;
      padding: 12px;
      border-radius: 999px;
      border: none;
      background: #00a86b;
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
  </style>

  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    // OneSignal (ROUE) ‚Äî App d√©di√©e √† chance.aperos.net
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      // basePath = dossier courant ("/" ou "/chance/")
      var basePath = new URL('.', window.location.href).pathname;

      await OneSignal.init({
        appId: "30a45559-ffb0-43f1-a533-18aa30b3cfac",
        notifyButton: { enable: false },
        serviceWorkerPath: basePath + "OneSignalSDKWorker.js",
        serviceWorkerUpdaterPath: basePath + "OneSignalSDKUpdaterWorker.js",
        serviceWorkerParam: { scope: basePath }
      });
    });
  </script>
</head>
<body>
  <div class="lang-flag">üá´üá∑</div>
  <div class="pointer"></div>
  <div class="wheel-container">
    <div id="wheel"></div>
  </div>
  <button id="spinButton">TOURNER LA ROUE</button>
  <div id="result"></div>

  <!-- POPUP JOUER -->
  <div id="playOverlay" class="overlay play-overlay">
    <div class="card">
      <div class="play-header">
        <h2>Jouer</h2>
        <span>üá´üá∑</span>
      </div>
      <ol class="play-steps">
        <li>Laissez-nous votre avis</li>
        <li>Retournez √† la page du jeu ‚Ü©</li>
        <li>Jouez pour gagner un cadeau</li>
      </ol>
      <button id="btnGoToReview" class="primary-btn">‚≠ê Avis</button>
    </div>
  </div>

  <!-- POPUP EMOJIS -->
  <div id="reviewOverlay" class="overlay" style="background:rgba(0,0,0,0.55);">
    <div class="card">
      <h2>Laissez votre avis</h2>
      <p>Partagez votre exp√©rience :</p>
      <div class="emoji-row">
        <button id="btnBad" class="emoji-btn">
          <span class="emoji-icon">üò°</span>
          <div class="emoji-label" style="color:#e53935">Horrible</div>
        </button>
        <button id="btnMedium" class="emoji-btn">
          <span class="emoji-icon">üòê</span>
          <div class="emoji-label" style="color:#fbc02d">Moyen</div>
        </button>
        <button id="btnGood" class="emoji-btn">
          <span class="emoji-icon">üòÅ</span>
          <div class="emoji-label" style="color:#43a047">Excellent</div>
        </button>
      </div>
    </div>
  </div>

  <!-- POPUP NOTE INTERNE -->
  <div id="starOverlay" class="overlay" style="background:rgba(0,0,0,0.55);">
    <div class="card">
      <h2>Votre avis</h2>
      <p>Notez votre exp√©rience :</p>
      <div class="star-container">
        <span class="star" data-value="1">‚òÖ</span>
        <span class="star" data-value="2">‚òÖ</span>
        <span class="star" data-value="3">‚òÖ</span>
        <span class="star" data-value="4">‚òÖ</span>
        <span class="star" data-value="5">‚òÖ</span>
      </div>
      <textarea id="badComment" placeholder="Partagez votre exp√©rience ici‚Ä¶"></textarea>
      <div id="loadingBar" class="loading-bar">
        <div class="loading-bar-inner"></div>
      </div>
      <button id="btnPublishInternal" class="primary-btn">Publier</button>
    </div>
  </div>

  <!-- POPUP GAIN -->
  <div id="prizeOverlay" class="overlay" style="background:rgba(0,0,0,0.65);">
    <div class="card prize-card">
      <h2 id="prizeTitle" class="prize-title"></h2>
      <p id="prizeText" class="prize-text"></p>
      <div id="prizeCode" class="prize-code"></div>
      <p id="prizeSite" class="prize-site"></p>
      <p id="prizeDates" class="prize-dates"></p>
      <button id="btnSeeSite" class="prize-btn-site">Voir le site</button>
    </div>
  </div>

<script>
const wheel = document.getElementById("wheel");
const spinButton = document.getElementById("spinButton");
const result = document.getElementById("result");

const segments = [
  "iPhone 16",
  "Livraison offerte",
  "-10%",
  "Une bouteille de Poliakov",
  "-10%",
  "-50%"
];

const prizeWeights = {
  "iPhone 16": 0,
  "-10%": 40,
  "Livraison offerte": 40,
  "-50%": 15,
  "Une bouteille de Poliakov": 2
};

const prizePopupContent = {
  "iPhone 16": {
    title: "üéâ iPhone 16",
    text: "Jackpot th√©orique iPhone 16 (probabilit√© 0 % dans ce jeu).",
    code: "IPH16"
  },
  "Livraison offerte": {
    title: "üöö Livraison offerte",
    text: "Tu as gagn√© la livraison offerte sur ta prochaine commande.",
    code: "L1V0F"
  },
  "-10%": {
    title: "üéÅ R√©duction -10%",
    text: "Tu as gagn√© -10% sur ta prochaine commande.",
    code: "T9H3A"
  },
  "-50%": {
    title: "üî• R√©duction -50%",
    text: "Tu as gagn√© -50% sur ta prochaine commande.",
    code: "Q5L8Z"
  },
  "Une bouteille de Poliakov": {
    title: "üçæ Bouteille de Poliakov",
    text: "Tu as gagn√© une bouteille de Poliakov.",
    code: "P0LK4"
  }
};

let currentRotation = 0;
let canSpin = false;
let isSpinning = false;
const sectorCount = segments.length;
const sectorSize = 360 / sectorCount;

/* Gestion du verrou 3 mois */
let isLockedFromPrize = false;
let savedPrizeData = null;

function randomWeighted() {
  const weights = segments.map(s => prizeWeights[s] || 0);
  let total = weights.reduce((a,b)=>a+b,0);
  if (total <= 0) return Math.floor(Math.random() * segments.length);
  let r = Math.random() * total;
  for (let i=0;i<weights.length;i++){
    r -= weights[i];
    if (r <= 0) return i;
  }
  return 0;
}

function formatDateFr(d) {
  return d.toLocaleDateString("fr-FR");
}

/* Pop-up gain */
const prizeOverlay = document.getElementById("prizeOverlay");
const prizeTitle = document.getElementById("prizeTitle");
const prizeText = document.getElementById("prizeText");
const prizeCode = document.getElementById("prizeCode");
const prizeSite = document.getElementById("prizeSite");
const prizeDates = document.getElementById("prizeDates");
const btnSeeSite = document.getElementById("btnSeeSite");

/* URL vers ton site */
const SITE_URL = "https://www.aperodenuit.com/";

/**
 * Affiche le popup de gain.
 * Si storedData est fourni, on r√©utilise les dates & infos d√©j√† enregistr√©es.
 */
function showPrizePopup(prizeName, storedData) {
  const data = prizePopupContent[prizeName] || {
    title: "Lot gagn√©",
    text: "Contenu √† d√©finir.",
    code: "XXXXX"
  };

  prizeTitle.textContent = data.title;
  prizeText.textContent = data.text;
  prizeCode.textContent = "CODE : " + data.code;
  prizeSite.textContent = "Valable sur aperodenuit.com";

  let start, end, lockUntil;

  if (storedData && storedData.start && storedData.end && storedData.lockUntil) {
    start = new Date(storedData.start);
    end = new Date(storedData.end);
    lockUntil = new Date(storedData.lockUntil);
  } else {
    const today = new Date();
    start = new Date(today);
    start.setDate(start.getDate() - 1);
    end = new Date(today);
    end.setDate(end.getDate() + 67);

    // Verrouillage pendant 3 mois
    lockUntil = new Date(today);
    lockUntil.setMonth(lockUntil.getMonth() + 3);

    // Sauvegarde dans localStorage
    const toSave = {
      prizeName,
      code: data.code,
      start: start.toISOString(),
      end: end.toISOString(),
      lockUntil: lockUntil.toISOString()
    };
    savedPrizeData = toSave;
    isLockedFromPrize = true;
    try {
      localStorage.setItem("aperoRouePrize", JSON.stringify(toSave));
    } catch (e) {
      console.error("Impossible de sauvegarder le gain :", e);
    }
  }

  prizeDates.textContent = "Du " + formatDateFr(start) + " au " + formatDateFr(end);
  prizeOverlay.style.display = "flex";

  if (lockUntil) {
    result.textContent = "üéÅ Tu as d√©j√† jou√©. Tu pourras rejouer apr√®s le " + formatDateFr(lockUntil) + ".";
  }
}

btnSeeSite.addEventListener("click", () => {
  window.open(SITE_URL, "_blank");
});

/* Popups avis */
const playOverlay = document.getElementById("playOverlay");
const reviewOverlay = document.getElementById("reviewOverlay");
const starOverlay = document.getElementById("starOverlay");

document.getElementById("btnGoToReview").onclick = () => {
  // Si d√©j√† verrouill√© par un gain, on affiche juste le gain
  if (isLockedFromPrize && savedPrizeData) {
    showPrizePopup(savedPrizeData.prizeName, savedPrizeData);
    return;
  }
  playOverlay.style.display = "none";
  reviewOverlay.style.display = "flex";
};

/* Emojis */
document.getElementById("btnBad").onclick = () => {
  reviewOverlay.style.display = "none";
  starOverlay.style.display = "flex";
};

document.getElementById("btnMedium").onclick = () => {
  reviewOverlay.style.display = "none";
  starOverlay.style.display = "flex";
};

document.getElementById("btnGood").onclick = () => {
  // Lien Google Avis mis √† jour
  window.open("https://g.page/r/CeR1XkHseNX9EBM/review", "_blank");
  reviewOverlay.style.display = "none";
  // On ne redonne le droit de jouer que si pas d√©j√† verrouill√© par un gain
  spinButton.disabled = true;
  result.textContent = "";
  setTimeout(() => {
    if (!isLockedFromPrize) {
      canSpin = true;
      spinButton.disabled = false;
      result.textContent = "‚úÖ Tu peux maintenant tourner la roue.";
    }
  }, 10000);
};

/* √âtoiles */
let internalRating = 0;
document.querySelectorAll(".star").forEach(star => {
  star.onclick = () => {
    internalRating = Number(star.dataset.value);
    document.querySelectorAll(".star").forEach(s => {
      s.classList.toggle("active", Number(s.dataset.value) <= internalRating);
    });
  };
});

/* Publier avis interne + barre chargement */
document.getElementById("btnPublishInternal").onclick = () => {
  if (internalRating === 0) {
    alert("Merci de choisir une note.");
    return;
  }
  const loadingBar = document.getElementById("loadingBar");
  loadingBar.style.display = "block";
  setTimeout(() => {
    loadingBar.style.display = "none";
    starOverlay.style.display = "none";
    spinButton.disabled = true;
    result.textContent = "";
    setTimeout(() => {
      if (!isLockedFromPrize) {
        canSpin = true;
        spinButton.disabled = false;
        result.textContent = "‚úÖ Tu peux maintenant tourner la roue.";
      }
    }, 1000);
  }, 1000);
};

/* Spin de la roue (6 secondes) */
function spin() {
  if (!canSpin || isSpinning || isLockedFromPrize) {
    // Si verrouill√© par un gain, on r√©affiche le popup du gain
    if (isLockedFromPrize && savedPrizeData) {
      showPrizePopup(savedPrizeData.prizeName, savedPrizeData);
    }
    return;
  }
  isSpinning = true;
  spinButton.disabled = true;

  const targetIndex = randomWeighted();
  const prizeName = segments[targetIndex];

  const targetDeg = (360 - targetIndex * sectorSize) % 360;
  const currentDeg = ((currentRotation % 360) + 360) % 360;
  const delta = (targetDeg - currentDeg + 360) % 360;

  currentRotation += 360 * 6 + delta;
  wheel.style.transform = `rotate(${currentRotation}deg)`;

  result.textContent = "La roue tourne...";

  setTimeout(() => {
    result.textContent = "üéÅ Tu as gagn√© : " + prizeName + " !";
    setTimeout(() => {
      showPrizePopup(prizeName);
      isSpinning = false;
      // M√™me si showPrizePopup verrouille, on ne r√©active pas vraiment le bouton
      spinButton.disabled = false;
    }, 2000);
  }, 6000);
}

/* Clicks */
spinButton.onclick = () => {
  if (isLockedFromPrize && savedPrizeData) {
    // D√©j√† un gain : on montre le popup de ce gain
    showPrizePopup(savedPrizeData.prizeName, savedPrizeData);
    return;
  }
  if (!canSpin) {
    playOverlay.style.display = "flex";
  } else {
    spin();
  }
};

wheel.onclick = spinButton.onclick;

/* Initialisation : on regarde s'il y a d√©j√† un gain sauvegard√© */
(function initPrizeLock() {
  try {
    const raw = localStorage.getItem("aperoRouePrize");
    if (!raw) return;
    const data = JSON.parse(raw);
    if (!data.lockUntil || !data.prizeName) return;

    const now = new Date();
    const lockUntil = new Date(data.lockUntil);

    if (now < lockUntil) {
      // Toujours verrouill√© : on r√©affiche le gain
      savedPrizeData = data;
      isLockedFromPrize = true;
      canSpin = false;
      showPrizePopup(data.prizeName, data);
    } else {
      // Verrou expir√© : on efface les donn√©es
      localStorage.removeItem("aperoRouePrize");
    }
  } catch (e) {
    console.error("Erreur lors de l'initialisation du gain :", e);
  }
})();
</script>
<script>
(function(){
  async function demanderNotifOneSignal(){
    try{
      if (typeof Notification !== "undefined" && Notification.permission === "denied") return;
      if (localStorage.getItem("notifAsked")) return;
      localStorage.setItem("notifAsked","1");

      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal){
        try{
          await new Promise(r => setTimeout(r, 80));
          await OneSignal.Notifications.requestPermission();
        }catch(e){}
      });
    }catch(e){}
  }

  document.addEventListener("DOMContentLoaded", function(){
    var btn = document.getElementById("spinButton"); // bouton TOURNER LA ROUE
    if (btn) btn.addEventListener("click", demanderNotifOneSignal, true);
  });
})();
</script>
</body>
</html>
