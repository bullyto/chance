<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Roue Ap√©ro de Nuit 66</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- META pour l‚Äôaper√ßu quand tu partages le lien (Messenger, etc.) -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Roue Ap√©ro de Nuit 66 - Gagne ton cadeau">
  <meta property="og:description" content="Laisse ton avis et tente de gagner livraison offerte, r√©ductions ou bouteilles avec Ap√©ro de Nuit 66.">
  <meta property="og:image" content="https://bullyto.github.io/chance/partager-1200x630.png">
  <!-- ‚ö†Ô∏è √Ä MODIFIER : mets ici l‚ÄôURL exacte de la page GitHub Pages -->
  <meta property="og:url" content="https://bullyto.github.io/chance/">

  <!-- Optionnel mais utile pour Twitter / certains clients -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Roue Ap√©ro de Nuit 66 - Gagne ton cadeau">
  <meta name="twitter:description" content="Laisse ton avis et tente de gagner livraison offerte, r√©ductions ou bouteilles avec Ap√©ro de Nuit 66.">
  <meta name="twitter:image" content="https://bullyto.github.io/chance/partager-1200x630.png">

  <!-- Ancienne balise utilis√©e par certains services -->
  <link rel="image_src" href="https://bullyto.github.io/chance/partager-1200x630.png" />

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: radial-gradient(circle at top, #1c2740 0%, #02030a 60%, #000 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #fff;
      overflow-x: hidden;
    }
    .lang-flag {
      position: fixed;
      top: 8px;
      right: 10px;
      font-size: 22px;
      z-index: 1000;
    }
    /* FL√àCHE ROUGE */
    .pointer {
      width: 0;
      height: 0;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-top: 34px solid #ff3b2f;
      margin-top: 50px;
    }
    .wheel-container {
      display: flex;
      justify-content: center;
      margin-top: 5px;
    }
    #wheel {
      width: 330px;
      height: 330px;
      border-radius: 50%;
      background-image: url("https://image.noelshack.com/fichiers/2025/50/3/1765329444-file-00000000486c71f49c21aafc0dae1d69-2.jpg");
      background-size: cover;
      background-position: center;
      transition: transform 6s cubic-bezier(0.15, 0.85, 0.15, 1); /* 6 s */
      filter: drop-shadow(0 0 22px rgba(255,215,0,0.8));
      cursor: pointer;
    }
    #spinButton {
      margin-top: 25px;
      padding: 16px 32px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #00c6ff, #0072ff);
      color: #fff;
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
      width: 80%;
      max-width: 320px;
    }
    #spinButton:disabled { opacity: 0.5; cursor: default; }
    #result {
      margin-top: 16px;
      font-size: 18px;
      min-height: 1.6em;
      text-align: center;
    }
    .overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(6px);
    }
    /* POPUP JOUER */
    .play-overlay {
      background: rgba(5, 10, 25, 0.80) !important;
    }
    .card {
      background: #ffffffee;
      color: #111;
      width: 86vw;
      max-width: 360px;
      border-radius: 22px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
    }
    .play-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .play-header h2 {
      margin: 0;
      font-size: 24px;
    }
    .play-steps {
      margin: 8px 0 0 0;
      padding-left: 22px;
      color: #555;
      font-size: 16px;
    }
    .primary-btn {
      margin-top: 22px;
      width: 100%;
      padding: 13px;
      border-radius: 999px;
      border: none;
      background: #1a73e8;
      color: #fff;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
    }
    /* EMOJIS */
    .emoji-row {
      display: flex;
      justify-content: center;
      gap: 18px;
      margin-top: 12px;
    }
    .emoji-btn {
      border: none;
      background: none;
      cursor: pointer;
      text-align: center;
    }
    .emoji-icon { font-size: 36px; margin-bottom: 4px; }
    .emoji-label { font-size: 13px; font-weight: 600; }
    /* POPUP NOTE GOOGLE */
    .star-container {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin: 10px 0;
    }
    .star {
      font-size: 32px;
      cursor: pointer;
      color: #dadce0;
      transition: 0.15s;
    }
    .star.active {
      color: #fbbc05;
      transform: scale(1.15);
    }
    #badComment {
      width: 100%;
      min-height: 90px;
      margin-top: 6px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #ccc;
      resize: vertical;
    }
    /* BARRE DE CHARGEMENT */
    .loading-bar {
      width: 100%;
      height: 4px;
      border-radius: 999px;
      background: rgba(26,115,232,0.18);
      overflow: hidden;
      margin-top: 10px;
      display: none;
    }
    .loading-bar-inner {
      width: 40%;
      height: 100%;
      background: #1a73e8;
      border-radius: inherit;
      transform: translateX(-100%);
      animation: loadingSlide 1s linear infinite;
    }
    @keyframes loadingSlide {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(260%); }
    }
    /* POPUP GAIN */
    .prize-card { text-align: left; }
    .prize-title {
      margin: 0 0 8px;
      font-size: 22px;
    }
    .prize-text {
      margin: 0 0 12px;
      font-size: 15px;
      color: #444;
    }
    /* zone du CODE plus GRIS */
    .prize-code {
      margin: 14px 0 8px;
      padding: 10px 14px;
      border-radius: 14px;
      background: #d4d4d4;
      color: #111;
      text-align: center;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.06em;
    }
    .prize-site {
      margin: 4px 0 4px;
      font-size: 14px;
      color: #5f6368;
      text-align: center;
    }
    .prize-dates {
      margin: 4px 0 0;
      font-size: 12px;
      color: #9aa0a6;
      text-align: center;
    }
    .prize-btn-site {
      margin-top: 18px;
      width: 100%;
      padding: 12px;
      border-radius: 999px;
      border: none;
      background: #00a86b;
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
  
/* Prize popup FX (scoped) */
#prizeOverlay.fx-on .fx-aura{animation: auraPop 1.4s ease-out forwards;}
#prizeOverlay.fx-on .fx-rays{animation: raysPop 1.4s ease-out forwards, raysSpin 7s linear infinite;}
#prizeOverlay.fx-on .fx-shadow{animation: shadowBounce 1.4s ease-out forwards;}
#prizeOverlay.fx-on .fx-icon{animation: dropBounce 1.4s ease-out forwards;}
#prizeOverlay.fx-on .fx-tip{animation: tipIn 1.4s ease-out forwards;}
#prizeOverlay.fx-on .fx-spark{animation: spark 1.4s ease-out forwards;}

#prizeOverlay .prize-stage{position:relative;width:100%;height:260px;display:grid;place-items:center;margin:0 0 10px;}
#prizeOverlay .prize-badge{position:absolute;top:10px;left:10px;padding:8px 10px;font-size:12px;color:rgba(255,255,255,.85);background:rgba(0,0,0,.28);border:1px solid rgba(255,255,255,.18);border-radius:999px;backdrop-filter:blur(10px);}
#prizeOverlay .fx-aura{position:absolute;width:260px;height:260px;border-radius:50%;background:radial-gradient(circle at 50% 50%,rgba(255,210,120,.90) 0%,rgba(255,170,0,.55) 18%,rgba(255,80,0,.20) 38%,rgba(255,80,0,0) 70%);filter:blur(6px);opacity:0;transform:translateY(14px) scale(.75);pointer-events:none;}
#prizeOverlay .fx-rays{position:absolute;width:300px;height:300px;border-radius:50%;opacity:0;transform:translateY(14px) scale(.75) rotate(0deg);background:repeating-conic-gradient(from 0deg,rgba(255,210,120,.22) 0deg 10deg,rgba(255,210,120,0) 10deg 22deg);mask:radial-gradient(circle at 50% 50%,transparent 0 38%,#000 55%,transparent 76%);filter:blur(.5px);pointer-events:none;}
#prizeOverlay .fx-spark{position:absolute;width:6px;height:6px;border-radius:50%;background:radial-gradient(circle,rgba(255,255,255,1),rgba(255,255,255,0));opacity:0;filter:drop-shadow(0 0 10px rgba(255,210,120,.9));pointer-events:none;}
#prizeOverlay .fx-shadow{position:absolute;bottom:54px;width:90px;height:18px;border-radius:50%;background:rgba(0,0,0,.45);filter:blur(4px);transform:scale(0);opacity:0;pointer-events:none;}
#prizeOverlay .fx-icon{position:relative;font-size:92px;transform-origin:bottom center;opacity:0;filter:drop-shadow(0 10px 18px rgba(0,0,0,.55)) drop-shadow(0 0 0 rgba(255,210,120,0));z-index:5;}
#prizeOverlay .fx-tip{position:absolute;bottom:10px;font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:rgba(255,255,255,.7);opacity:0;}
#prizeOverlay .fx-spark.s1{ left:40px;  top:120px; animation-delay:.35s;}
#prizeOverlay .fx-spark.s2{ left:80px;  top:70px;  animation-delay:.38s;}
#prizeOverlay .fx-spark.s3{ left:140px; top:40px;  animation-delay:.40s;}
#prizeOverlay .fx-spark.s4{ left:210px; top:55px;  animation-delay:.42s;}
#prizeOverlay .fx-spark.s5{ left:255px; top:100px; animation-delay:.45s;}
#prizeOverlay .fx-spark.s6{ left:265px; top:160px; animation-delay:.48s;}
#prizeOverlay .fx-spark.s7{ left:230px; top:210px; animation-delay:.50s;}
#prizeOverlay .fx-spark.s8{ left:150px; top:235px; animation-delay:.52s;}
#prizeOverlay .fx-spark.s9{ left:75px;  top:210px; animation-delay:.54s;}
#prizeOverlay .fx-spark.s10{left:35px;  top:170px; animation-delay:.56s;}

@keyframes dropBounce{0%{transform:translateY(-340px) scaleY(1);opacity:0;filter:drop-shadow(0 10px 18px rgba(0,0,0,.55));}28%{opacity:1;}40%{transform:translateY(0) scaleY(.70);filter:drop-shadow(0 10px 18px rgba(0,0,0,.55)) drop-shadow(0 0 28px rgba(255,210,120,.55));}55%{transform:translateY(-48px) scaleY(1.05);}70%{transform:translateY(0) scaleY(.84);}82%{transform:translateY(-16px) scaleY(1.02);}92%{transform:translateY(0) scaleY(.95);}100%{transform:translateY(0) scaleY(1);opacity:1;filter:drop-shadow(0 10px 18px rgba(0,0,0,.55)) drop-shadow(0 0 36px rgba(255,210,120,.65));}}
@keyframes auraPop{0%{opacity:0;transform:translateY(18px) scale(.70);}35%{opacity:.95;transform:translateY(10px) scale(.95);}55%{opacity:1;transform:translateY(6px) scale(1);}100%{opacity:.85;transform:translateY(6px) scale(1.04);}}
@keyframes raysPop{0%{opacity:0;transform:translateY(18px) scale(.70) rotate(0deg);}45%{opacity:.85;transform:translateY(10px) scale(.98) rotate(0deg);}100%{opacity:.55;transform:translateY(10px) scale(1.06) rotate(0deg);}}
@keyframes raysSpin{to{transform:translateY(10px) scale(1.06) rotate(360deg);}}
@keyframes shadowBounce{0%{transform:scale(0);opacity:0;}35%{transform:scale(.25);opacity:0;}40%{transform:scale(1);opacity:.9;}55%{transform:scale(.78);opacity:.55;}70%{transform:scale(.96);opacity:.70;}100%{transform:scale(.90);opacity:.55;}}
@keyframes spark{0%{opacity:0;transform:scale(.4);}45%{opacity:0;transform:scale(.4);}60%{opacity:1;transform:scale(1.35);}80%{opacity:.9;transform:scale(.95);}100%{opacity:0;transform:scale(1.6);}}
@keyframes tipIn{0%{opacity:0;transform:translateY(6px);}65%{opacity:0;transform:translateY(6px);}100%{opacity:.85;transform:translateY(0);}}

/* Wheel glow while spinning (visual only) */
#wheel{position:relative}
#wheel.spinning{filter:drop-shadow(0 0 28px rgba(255,215,0,.65)) drop-shadow(0 0 40px rgba(0,198,255,.25));}
#wheel.spinning::after{content:"";position:absolute;inset:-14px;border-radius:50%;background:radial-gradient(circle at 50% 50%,rgba(255,210,120,.18) 0%,rgba(255,120,0,.10) 35%,rgba(255,120,0,0) 70%);filter:blur(2px);animation:wheelPulse .55s ease-in-out infinite alternate;pointer-events:none;}
@keyframes wheelPulse{from{transform:scale(.98);opacity:.7}to{transform:scale(1.03);opacity:1}}



/* ===== Bulb chase FX around wheel (visual only) ===== */
#wheel-container{position:relative}
#wheel-container .bulbs{
  position:absolute;
  inset:-12px;
  pointer-events:none;
  z-index:3;
}
#wheel-container .bulbs i{
  position:absolute;
  width:10px; height:10px;
  border-radius:50%;
  background: rgba(255,215,0,.35);
  box-shadow: 0 0 10px rgba(255,215,0,.20);
  opacity:.45;
  transform: translate(-50%,-50%);
}
#wheel-container.spinning .bulbs i{
  animation: bulbChase 0.9s linear infinite;
  opacity:1;
}
@keyframes bulbChase{
  0%,100%{ filter: brightness(1); box-shadow: 0 0 10px rgba(255,215,0,.25); opacity:.55; }
  50%{ filter: brightness(2.2); box-shadow: 0 0 22px rgba(255,215,0,.75), 0 0 40px rgba(255,160,0,.35); opacity:1; }
}
/* soft backlight behind wheel while spinning */
#wheel-container::before{
  content:"";
  position:absolute;
  inset:-24px;
  border-radius:50%;
  background: radial-gradient(circle at 50% 50%,
    rgba(255,210,120,.18) 0%,
    rgba(0,198,255,.10) 35%,
    rgba(0,0,0,0) 70%);
  filter: blur(6px);
  opacity:0;
  transform: scale(.92);
  transition: opacity .2s ease, transform .2s ease;
  pointer-events:none;
  z-index:1;
}
#wheel-container.spinning::before{
  opacity:1;
  transform: scale(1.00);
}

</style>
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "38b45559-ffdb-43f1-a533-18aa30b3cfac",
    });
  });
</script>


  <!-- PWA / Ic√¥nes -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" type="image/png" sizes="192x192" href="icone-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icone-512.png">
  <link rel="apple-touch-icon" href="icone-touch-apple.png">


</head>
<body>
  <div class="lang-flag">üá´üá∑</div>
  <div class="pointer"></div>
  <div class="wheel-container">
    <div id="wheel"></div>
  </div>
  <button id="spinButton">TOURNER LA ROUE</button>
  <div id="result"></div>

  <!-- POPUP JOUER -->
  <div id="playOverlay" class="overlay play-overlay">
    <div class="card">
      <div class="play-header">
        <h2>Jouer</h2>
        <span>üá´üá∑</span>
      </div>
      <ol class="play-steps">
        <li>Laissez-nous votre avis</li>
        <li>Retournez √† la page du jeu ‚Ü©</li>
        <li>Jouez pour gagner un cadeau</li>
      </ol>
      <button id="btnGoToReview" class="primary-btn">‚≠ê Avis</button>
    </div>
  </div>

  <!-- POPUP EMOJIS -->
  <div id="reviewOverlay" class="overlay" style="background:rgba(0,0,0,0.55);">
    <div class="card">
      <h2>Laissez votre avis</h2>
      <p>Partagez votre exp√©rience :</p>
      <div class="emoji-row">
        <button id="btnBad" class="emoji-btn">
          <span class="emoji-icon">üò°</span>
          <div class="emoji-label" style="color:#e53935">Horrible</div>
        </button>
        <button id="btnMedium" class="emoji-btn">
          <span class="emoji-icon">üòê</span>
          <div class="emoji-label" style="color:#fbc02d">Moyen</div>
        </button>
        <button id="btnGood" class="emoji-btn">
          <span class="emoji-icon">üòÅ</span>
          <div class="emoji-label" style="color:#43a047">Excellent</div>
        </button>
      </div>
    </div>
  </div>

  <!-- POPUP NOTE INTERNE -->
  <div id="starOverlay" class="overlay" style="background:rgba(0,0,0,0.55);">
    <div class="card">
      <h2>Votre avis</h2>
      <p>Notez votre exp√©rience :</p>
      <div class="star-container">
        <span class="star" data-value="1">‚òÖ</span>
        <span class="star" data-value="2">‚òÖ</span>
        <span class="star" data-value="3">‚òÖ</span>
        <span class="star" data-value="4">‚òÖ</span>
        <span class="star" data-value="5">‚òÖ</span>
      </div>
      <textarea id="badComment" placeholder="Partagez votre exp√©rience ici‚Ä¶"></textarea>
      <div id="loadingBar" class="loading-bar">
        <div class="loading-bar-inner"></div>
      </div>
      <button id="btnPublishInternal" class="primary-btn">Publier</button>
    </div>
  </div>

  <!-- POPUP GAIN -->
  <div id="prizeOverlay" class="overlay" style="background:rgba(0,0,0,0.65);">
    <div class="card prize-card">
      <div class="prize-stage" aria-hidden="true">
        <div class="prize-badge">Gain obtenu ‚ú®</div>
        <div class="fx-aura"></div>
        <div class="fx-rays"></div>
        <div class="fx-spark s1"></div><div class="fx-spark s2"></div><div class="fx-spark s3"></div><div class="fx-spark s4"></div><div class="fx-spark s5"></div>
        <div class="fx-spark s6"></div><div class="fx-spark s7"></div><div class="fx-spark s8"></div><div class="fx-spark s9"></div><div class="fx-spark s10"></div>
        <div class="fx-shadow"></div>
        <div id="prizeIcon" class="fx-icon">üéÅ</div>
        <div class="fx-tip">Incroyable apparition</div>
      </div>

      <h2 id="prizeTitle" class="prize-title"></h2>
      <p id="prizeText" class="prize-text"></p>
      <div id="prizeCode" class="prize-code"></div>
      <p id="prizeSite" class="prize-site"></p>
      <p id="prizeDates" class="prize-dates"></p>
      <button id="btnSeeSite" class="prize-btn-site">Voir le site</button>
    </div>
  </div>

<script>
const wheel = document.getElementById("wheel");
const spinButton = document.getElementById("spinButton");
const result = document.getElementById("result");

const segments = [
  "iPhone 16",
  "Livraison offerte",
  "-10%",
  "Une bouteille de Poliakov",
  "-10%",
  "-50%"
];

const prizeWeights = {
  "iPhone 16": 0,
  "-10%": 20,
  "Livraison offerte": 50,
  "-50%": 25,
  "Une bouteille de Poliakov": 2
};

const prizePopupContent = {
  "iPhone 16": {
    title: "üéâ iPhone 16",
    text: "Jackpot th√©orique iPhone 16 (probabilit√© 0 % dans ce jeu).",
    code: "IPH16"
  },
  "Livraison offerte": {
    title: "üöö Livraison offerte",
    text: "Tu as gagn√© la livraison offerte sur ta prochaine commande.",
    code: "L1V0F"
  },
  "-10%": {
    title: "üéÅ R√©duction -10%",
    text: "Tu as gagn√© -10% sur ta prochaine commande.",
    code: "T9H3A"
  },
  "-50%": {
    title: "üî• R√©duction -50%",
    text: "Tu as gagn√© -50% sur ta prochaine commande.",
    code: "Q5L8Z"
  },
  "Une bouteille de Poliakov": {
    title: "üçæ Bouteille de Poliakov",
    text: "Tu as gagn√© une bouteille de Poliakov.",
    code: "P0LK4"
  }
};

let currentRotation = 0;
let canSpin = false;
let isSpinning = false;
const sectorCount = segments.length;
const sectorSize = 360 / sectorCount;

/* Gestion du verrou 3 mois */
let isLockedFromPrize = false;
let savedPrizeData = null;

function randomWeighted() {
  const weights = segments.map(s => prizeWeights[s] || 0);
  let total = weights.reduce((a,b)=>a+b,0);
  if (total <= 0) return Math.floor(Math.random() * segments.length);
  let r = Math.random() * total;
  for (let i=0;i<weights.length;i++){
    r -= weights[i];
    if (r <= 0) return i;
  }
  return 0;
}

function formatDateFr(d) {
  return d.toLocaleDateString("fr-FR");
}

/* Pop-up gain */
const prizeOverlay = document.getElementById("prizeOverlay");
const prizeTitle = document.getElementById("prizeTitle");
const prizeText = document.getElementById("prizeText");
const prizeCode = document.getElementById("prizeCode");
const prizeSite = document.getElementById("prizeSite");
const prizeDates = document.getElementById("prizeDates");
const btnSeeSite = document.getElementById("btnSeeSite");

/* URL vers ton site */
const SITE_URL = "https://www.aperodenuit.com/";

/**
 * Affiche le popup de gain.
 * Si storedData est fourni, on r√©utilise les dates & infos d√©j√† enregistr√©es.
 */
function showPrizePopup(prizeName, storedData) {
  const data = prizePopupContent[prizeName] || {
    title: "Lot gagn√©",
    text: "Contenu √† d√©finir.",
    code: "XXXXX"
  };

  prizeTitle.textContent = data.title;
  prizeText.textContent = data.text;
  prizeCode.textContent = "CODE : " + data.code;
  prizeSite.textContent = "Valable sur aperodenuit.com";

  let start, end, lockUntil;

  if (storedData && storedData.start && storedData.end && storedData.lockUntil) {
    start = new Date(storedData.start);
    end = new Date(storedData.end);
    lockUntil = new Date(storedData.lockUntil);
  } else {
    const today = new Date();
    start = new Date(today);
    start.setDate(start.getDate() - 1);
    end = new Date(today);
    end.setDate(end.getDate() + 67);

    // Verrouillage pendant 3 mois
    lockUntil = new Date(today);
    lockUntil.setMonth(lockUntil.getMonth() + 3);

    // Sauvegarde dans localStorage
    const toSave = {
      prizeName,
      code: data.code,
      start: start.toISOString(),
      end: end.toISOString(),
      lockUntil: lockUntil.toISOString()
    };
    savedPrizeData = toSave;
    isLockedFromPrize = true;
    try {
      localStorage.setItem("aperoRouePrize", JSON.stringify(toSave));
    } catch (e) {
      console.error("Impossible de sauvegarder le gain :", e);
    }
  }

  prizeDates.textContent = "Du " + formatDateFr(start) + " au " + formatDateFr(end);
  prizeOverlay.classList.remove("fx-on");
  void prizeOverlay.offsetWidth;
  prizeOverlay.classList.add("fx-on");
  const _ic = document.getElementById("prizeIcon");
  if (_ic) _ic.textContent = prizeIconFor(prizeName);
  try{ bling(); }catch(e){}
  prizeOverlay.style.display = "flex";

  if (lockUntil) {
    result.textContent = "üéÅ Tu as d√©j√† jou√©. Tu pourras rejouer apr√®s le " + formatDateFr(lockUntil) + ".";
  }
}

btnSeeSite.addEventListener("click", () => {
  window.open(SITE_URL, "_blank");
});

/* Popups avis */
const playOverlay = document.getElementById("playOverlay");
const reviewOverlay = document.getElementById("reviewOverlay");
const starOverlay = document.getElementById("starOverlay");

document.getElementById("btnGoToReview").onclick = () => {
  // Si d√©j√† verrouill√© par un gain, on affiche juste le gain
  if (isLockedFromPrize && savedPrizeData) {
    showPrizePopup(savedPrizeData.prizeName, savedPrizeData);
    return;
  }
  playOverlay.style.display = "none";
  reviewOverlay.style.display = "flex";
};

/* Emojis */
document.getElementById("btnBad").onclick = () => {
  reviewOverlay.style.display = "none";
  starOverlay.style.display = "flex";
};

document.getElementById("btnMedium").onclick = () => {
  
  // Moyen -> Google Avis (comme Excellent)
  window.open("https://g.page/r/CeR1XkHseNX9EBM/review", "_blank");
  reviewOverlay.style.display = "none";

  // D√©verrouillage apr√®s quelques secondes (comme Excellent)
  spinButton.disabled = true;
  result.textContent = "";
  setTimeout(() => {
    if (!isLockedFromPrize) {
      canSpin = true;
      spinButton.disabled = false;
      result.textContent = "‚úÖ Tu peux maintenant tourner la roue.";
    }
  }, 10000);

};

document.getElementById("btnGood").onclick = () => {
  // Lien Google Avis mis √† jour
  window.open("https://g.page/r/CeR1XkHseNX9EBM/review", "_blank");
  reviewOverlay.style.display = "none";
  // On ne redonne le droit de jouer que si pas d√©j√† verrouill√© par un gain
  spinButton.disabled = true;
  result.textContent = "";
  setTimeout(() => {
    if (!isLockedFromPrize) {
      canSpin = true;
      spinButton.disabled = false;
      result.textContent = "‚úÖ Tu peux maintenant tourner la roue.";
    }
  }, 10000);
};

/* √âtoiles */
let internalRating = 0;
document.querySelectorAll(".star").forEach(star => {
  star.onclick = () => {
    internalRating = Number(star.dataset.value);
    document.querySelectorAll(".star").forEach(s => {
      s.classList.toggle("active", Number(s.dataset.value) <= internalRating);
    });
  };
});

/* Publier avis interne + barre chargement */
document.getElementById("btnPublishInternal").onclick = () => {
  if (internalRating === 0) {
    alert("Merci de choisir une note.");
    return;
  }
  const loadingBar = document.getElementById("loadingBar");
  loadingBar.style.display = "block";
  setTimeout(() => {
    loadingBar.style.display = "none";
    starOverlay.style.display = "none";
    spinButton.disabled = true;
    result.textContent = "";
    setTimeout(() => {
      if (!isLockedFromPrize) {
        canSpin = true;
        spinButton.disabled = false;
        result.textContent = "‚úÖ Tu peux maintenant tourner la roue.";
      }
    }, 1000);
  }, 1000);
};

/* Spin de la roue (6 secondes) */
function spin() {
  if (!canSpin || isSpinning || isLockedFromPrize) {
    // Si verrouill√© par un gain, on r√©affiche le popup du gain
    if (isLockedFromPrize && savedPrizeData) {
      showPrizePopup(savedPrizeData.prizeName, savedPrizeData);
    }
    return;
  }
  isSpinning = true;
  spinButton.disabled = true;
  wheel.classList.add("spinning");
  try{ whoosh(); }catch(e){}
  try{ startSpinSound(); }catch(e){}

  const targetIndex = randomWeighted();
  const prizeName = segments[targetIndex];

  const targetDeg = (360 - targetIndex * sectorSize) % 360;
  const currentDeg = ((currentRotation % 360) + 360) % 360;
  const delta = (targetDeg - currentDeg + 360) % 360;

  currentRotation += 360 * 6 + delta;
  wheel.style.transform = `rotate(${currentRotation}deg)`;

  result.textContent = "La roue tourne...";

  setTimeout(() => {
    wheel.classList.remove("spinning");
    try{ stopSpinSound(); }catch(e){}
    try{ thump(); }catch(e){}
    result.textContent = "üéÅ Tu as gagn√© : " + prizeName + " !";
    setTimeout(() => {
      showPrizePopup(prizeName);
      isSpinning = false;
      // M√™me si showPrizePopup verrouille, on ne r√©active pas vraiment le bouton
      spinButton.disabled = false;
    }, 2000);
  }, 6000);
}

/* Clicks */
spinButton.onclick = () => {
  if (isLockedFromPrize && savedPrizeData) {
    // D√©j√† un gain : on montre le popup de ce gain
    showPrizePopup(savedPrizeData.prizeName, savedPrizeData);
    return;
  }
  if (!canSpin) {
    playOverlay.style.display = "flex";
  } else {
    spin();
  }
};

wheel.onclick = spinButton.onclick;

/* Initialisation : on regarde s'il y a d√©j√† un gain sauvegard√© */
(function initPrizeLock() {
  try {
    const raw = localStorage.getItem("aperoRouePrize");
    if (!raw) return;
    const data = JSON.parse(raw);
    if (!data.lockUntil || !data.prizeName) return;

    const now = new Date();
    const lockUntil = new Date(data.lockUntil);

    if (now < lockUntil) {
      // Toujours verrouill√© : on r√©affiche le gain
      savedPrizeData = data;
      isLockedFromPrize = true;
      canSpin = false;
      showPrizePopup(data.prizeName, data);
    } else {
      // Verrou expir√© : on efface les donn√©es
      localStorage.removeItem("aperoRouePrize");
    }
  } catch (e) {
    console.error("Erreur lors de l'initialisation du gain :", e);
  }
})();
</script>

<script>
  // Demande la permission uniquement au clic sur le bouton
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("spinButton");
    if (!btn) return;

    btn.addEventListener("click", () => {
      try {
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
          try {
            // Chrome n'affiche pas de prompt si d√©j√† "granted" ou "denied"
            if (typeof Notification !== "undefined" && Notification.permission !== "default") return;
            await OneSignal.Notifications.requestPermission();
          } catch (e) {}
        });
      } catch (e) {}
    }, true);
  });


/* --- Extra immersive sounds (safe) --- */
let _spinTickTimer=null;
function startSpinSound(){
  try{ ensureAudio(); }catch(e){ return; }
  stopSpinSound();
  _spinTickTimer=setInterval(()=>{ try{ noiseBurst(0.02,0.05,500,6000); }catch(e){} }, 90);
}
function stopSpinSound(){
  if(_spinTickTimer){ clearInterval(_spinTickTimer); _spinTickTimer=null; }
}
function prizeIconFor(prizeName){
  const n=(prizeName||"").toLowerCase();
  if(n.includes("50")) return "ü§ë";
  if(n.includes("10")) return "‚ú®";
  if(n.includes("livraison")) return "üöö";
  if(n.includes("poliakov")||n.includes("bouteille")) return "üçæ";
  if(n.includes("iphone")) return "üì±";
  return "üéÅ";
}



/* ===== Build bulbs + staggered chase ===== */
(function initBulbs(){
  const container = document.getElementById("wheel-container");
  const bulbsHost = container ? container.querySelector(".bulbs") : null;
  if (!container || !bulbsHost) return;

  const count = 18;
  bulbsHost.innerHTML = "";
  for (let k=0;k<count;k++){
    const a = (Math.PI*2) * (k/count) - Math.PI/2;
    const x = 50 + (Math.cos(a) * 44);
    const y = 50 + (Math.sin(a) * 44);
    const b = document.createElement("i");
    b.style.left = x + "%";
    b.style.top  = y + "%";
    b.style.animationDelay = (k * (0.9 / count)) + "s";
    bulbsHost.appendChild(b);
  }
})();

</script>

</body>
</html>
